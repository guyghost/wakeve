# P1.4 Dashboard Backend + P1.5 RGPD Consent - Implementation Summary

## Overview
Implemented analytics dashboard backend and RGPD consent management for Wakeve.

## Files Created

### P1.4: Dashboard Backend

#### 1. Database Schema
**File**: `shared/src/commonMain/sqldelight/com/guyghost/wakeve/Analytics.sq`

Tables:
- `analytics` - Stores tracking events (events, sessions, funnels)
- `analytics_session` - Tracks user sessions for MAU/DAU calculation
- `analytics_funnel` - Tracks funnel events for conversion analysis

Queries:
- `getActiveUsersSince` - Count unique users since timestamp
- `getNewUsersOnDate` - Count new users on specific date
- `getRetainedUsers` - Count retained users for cohort analysis
- `getEventCount` - Count funnel events
- `getActiveEventsCount` - Count active events

#### 2. Analytics Service
**File**: `server/src/main/kotlin/com/guyghost/wakeve/analytics/AnalyticsDashboard.kt`

Features:
- **getMAU()** - Monthly Active Users (last 30 days)
- **getDAU()** - Daily Active Users (today, UTC)
- **getRetention(days)** - Cohort retention analysis (default: 7 days)
- **getEventCreationFunnel()** - Event creation conversion funnel
- **getMetricsSummary()** - All metrics combined

Data Classes:
- `Metrics` - MAU, DAU, new users, active events, retention
- `FunnelStep` - Funnel step name, count, conversion rate

#### 3. Analytics Routes
**File**: `server/src/main/kotlin/com/guyghost/wakeve/routes/AnalyticsRoutes.kt`

Endpoints (protected by JWT authentication):
- `GET /api/analytics/metrics` - All metrics summary
- `GET /api/analytics/mau` - Monthly Active Users
- `GET /api/analytics/dau` - Daily Active Users
- `GET /api/analytics/retention?days=7` - Retention analysis
- `GET /api/analytics/funnel` - Event creation funnel
- `GET /api/analytics/export?format=csv` - Export as CSV/JSON

#### 4. Application Integration
**File**: `server/src/main/kotlin/com/guyghost/wakeve/Application.kt`

Changes:
- Import `AnalyticsDashboard`
- Initialize `AnalyticsDashboard(database)` in `main()`
- Add `analyticsDashboard` parameter to `module()`
- Register `analyticsRoutes(analyticsDashboard)` in routing

### P1.5: RGPD Consent

#### 1. Consent Database Schema
**File**: `shared/src/commonMain/sqldelight/com/guyghost/wakeve/Consent.sq`

Table:
- `consent` - Stores user consent status (user_id, has_consent, consent_date, updated_at)

Queries:
- `selectConsentByUserId` - Get full consent record
- `hasGivenConsent` - Check if consent granted
- `insertConsent` - Insert new consent
- `updateConsent` - Update consent status
- `deleteConsent` - Remove consent record

#### 2. Consent Repository
**File**: `shared/src/commonMain/kotlin/com/guyghost/wakeve/consent/ConsentRepository.kt`

Interface:
- `hasGivenConsent(userId)` - Check consent status
- `grantConsent(userId)` - Grant consent
- `revokeConsent(userId)` - Revoke consent
- `getConsentDate(userId)` - Get consent grant date
- `observeConsent()` - Observe consent as StateFlow

Implementation:
- `ConsentRepositoryImpl` - SQLDelight-based implementation
- StateFlow-based reactive consent observation
- Thread-safe consent updates

#### 3. Consent Dialog Composable (Android)
**File**: `wakeveApp/src/commonMain/kotlin/com/guyghost/wakeve/ui/settings/ConsentDialog.kt`

Components:

**ConsentDialog**:
- First-launch dialog for requesting consent
- Shows data collection information
- Displays RGPD rights (expandable details)
- Accept/Reject buttons with analytics tracking

**ConsentSettingsItem**:
- Settings toggle for consent management
- Switch to enable/disable analytics
- Shows current status message
- Tracks consent grant/revoke events

## Integration Guide

### Android App Integration

#### 1. Show Consent Dialog on First Launch

```kotlin
// In your main activity or initialization code
val consentRepository = ConsentRepositoryImpl(
    // Provide platform-specific Settings or use dependency injection
)

val hasConsent = consentRepository.hasGivenConsent(userId)
if (!hasConsent) {
    // Show ConsentDialog
    ConsentDialog(
        consentRepository = consentRepository,
        analyticsProvider = analyticsProvider,
        onDismiss = { /* Navigate to main app */ }
    )
}
```

#### 2. Add Consent Settings

```kotlin
// In SettingsScreen.kt
LazyColumn {
    item {
        ConsentSettingsItem(
            consentRepository = consentRepository,
            analyticsProvider = analyticsProvider
        )
    }
}
```

#### 3. Initialize ConsentRepository

```kotlin
// In your DI container (e.g., Koin or Hilt)
val consentRepository = ConsentRepositoryImpl(database)
```

### Server Integration

#### 1. Analytics Endpoints are already configured

All analytics endpoints are registered in `Application.kt` and protected by JWT authentication.

#### 2. Accessing Analytics

```bash
# Get all metrics
curl -H "Authorization: Bearer $JWT_TOKEN" \
  http://localhost:8080/api/analytics/metrics

# Get MAU/DAU
curl -H "Authorization: Bearer $JWT_TOKEN" \
  http://localhost:8080/api/analytics/mau
curl -H "Authorization: Bearer $JWT_TOKEN" \
  http://localhost:8080/api/analytics/dau

# Get retention analysis
curl -H "Authorization: Bearer $JWT_TOKEN" \
  "http://localhost:8080/api/analytics/retention?days=7"

# Get funnel analysis
curl -H "Authorization: Bearer $JWT_TOKEN" \
  http://localhost:8080/api/analytics/funnel

# Export as CSV
curl -H "Authorization: Bearer $JWT_TOKEN" \
  "http://localhost:8080/api/analytics/export?format=csv"
```

## Validation Checklist

- [x] Analytics schema created (Analytics.sq)
- [x] Consent schema created (Consent.sq)
- [x] AnalyticsDashboard service implemented
- [x] Analytics routes configured
- [x] Application.kt updated
- [x] ConsentRepository interface and implementation
- [x] ConsentDialog composable created
- [x] ConsentSettingsItem composable created
- [x] SQLDelight interfaces generated successfully

## Pre-existing Issues

Note: There are pre-existing compilation errors in the server module unrelated to P1.4/P1.5:
- `AuditLogger.kt`: Instant serialization issue
- `SecurityConfig.kt`: Unresolved `origin` reference

These should be fixed separately.

## Technical Decisions

### SQLDelight for Persistence
**Decision**: Use SQLDelight instead of `russhwolf.settings`
**Reason**: Consistent with existing architecture, type-safe queries, cross-platform

### Funnel Implementation
**Decision**: Hardcoded funnel steps in service
**Reason**: Simple, maintainable, extensible for future funnels

### Retention Calculation
**Decision**: Simplified cohort analysis
**Reason**: Original SQLDelight couldn't parse complex queries; simplified to pragmatic solution

### StateFlow for Consent
**Decision**: Use StateFlow for reactive consent observation
**Reason**: Kotlin best practice, Compose-friendly, efficient updates

## Next Steps

1. Fix pre-existing server compilation errors
2. Add iOS implementation for ConsentDialog (SwiftUI)
3. Add unit tests for AnalyticsDashboard
4. Add unit tests for ConsentRepository
5. Add integration tests for analytics endpoints
6. Add analytics event tracking in client app
7. Test offline consent revocation scenario
8. Add GDPR data export functionality

## RGPD Compliance

### Implemented
- ✅ Explicit consent before data collection
- ✅ Consent can be revoked at any time
- ✅ User data cleared on revocation
- ✅ Consent timestamp recorded
- ✅ RGPD rights displayed in dialog

### Future Enhancements
- Data export (portability right)
- Complete data deletion (erasure right)
- Consent history tracking
- Granular consent options (analytics, crash reports, etc.)
