package com.guyghost.wakeve.gamification

import kotlinx.coroutines.test.runTest
import kotlin.test.Test
import kotlin.test.assertEquals
import kotlin.test.assertFalse
import kotlin.test.assertTrue

/**
 * Unit tests for point decay functionality.
 * Tests the 1% per day decay rule after 30 days of inactivity.
 */
class PointsDecayTest {

    @Test
    fun `UserPoints calculates decay amount correctly for active user`() {
        // Active user (less than 30 days since last update)
        val userPoints = UserPoints(
            userId = "user-1",
            totalPoints = 100,
            lastUpdated = java.time.Instant.now().toString()
        )
        assertFalse(userPoints.shouldApplyDecay())
        assertEquals(0, userPoints.calculateDecayAmount())
    }

    @Test
    fun `UserPoints calculates decay amount for inactive user`() {
        // Inactive user (more than 30 days since last update)
        val thirtyOneDaysAgo = java.time.Instant.now()
            .minus(31, java.time.temporal.ChronoUnit.DAYS)
            .toString()

        val userPoints = UserPoints(
            userId = "user-1",
            totalPoints = 1000,
            decayPoints = 0,
            lastUpdated = thirtyOneDaysAgo
        )

        assertTrue(userPoints.shouldApplyDecay())
        // 1% of 1000 = 10, minimum 1
        assertEquals(10, userPoints.calculateDecayAmount())
    }

    @Test
    fun `UserPoints decay minimum is 1 point`() {
        val thirtyOneDaysAgo = java.time.Instant.now()
            .minus(31, java.time.temporal.ChronoUnit.DAYS)
            .toString()

        val userPoints = UserPoints(
            userId = "user-1",
            totalPoints = 50,  // Small balance
            decayPoints = 0,
            lastUpdated = thirtyOneDaysAgo
        )

        assertTrue(userPoints.shouldApplyDecay())
        // 1% of 50 = 0.5, should round to 1 minimum
        assertEquals(1, userPoints.calculateDecayAmount())
    }

    @Test
    fun `UserPoints effective points includes decayed points`() {
        val userPoints = UserPoints(
            userId = "user-1",
            totalPoints = 1000,
            decayPoints = 100
        )
        assertEquals(1100, userPoints.effectivePoints)
    }

    @Test
    fun `decay starts after exactly 30 days`() {
        val exactly30DaysAgo = java.time.Instant.now()
            .minus(30, java.time.temporal.ChronoUnit.DAYS)
            .toString()

        val userPoints = UserPoints(
            userId = "user-1",
            totalPoints = 1000,
            lastUpdated = exactly30DaysAgo
        )

        // At exactly 30 days, decay should not apply (starts after 30 days)
        assertFalse(userPoints.shouldApplyDecay())
    }

    @Test
    fun `decay applies after 31 days`() {
        val thirtyOneDaysAgo = java.time.Instant.now()
            .minus(31, java.time.temporal.ChronoUnit.DAYS)
            .toString()

        val userPoints = UserPoints(
            userId = "user-1",
            totalPoints = 1000,
            lastUpdated = thirtyOneDaysAgo
        )

        assertTrue(userPoints.shouldApplyDecay())
    }

    @Test
    fun `decay rate is 1 percent`() {
        val thirtyOneDaysAgo = java.time.Instant.now()
            .minus(31, java.time.temporal.ChronoUnit.DAYS)
            .toString()

        val userPoints = UserPoints(
            userId = "user-1",
            totalPoints = 10000,  // Large balance for accurate percentage
            decayPoints = 0,
            lastUpdated = thirtyOneDaysAgo
        )

        // 1% of 10000 = 100
        assertEquals(100, userPoints.calculateDecayAmount())
    }

    @Test
    fun `points never go negative with decay`() {
        val userPoints = UserPoints(
            userId = "user-1",
            totalPoints = 0,
            decayPoints = 0,
            lastUpdated = ""
        )

        // Should never apply decay to zero points
        assertFalse(userPoints.shouldApplyDecay())
    }

    @Test
    fun `GamificationService constants define correct decay parameters`() {
        assertEquals(30, GamificationService.DECAY_START_DAYS)
        assertEquals(0.01, GamificationService.DECAY_RATE, 0.001)
    }

    @Test
    fun `point values match specification`() {
        assertEquals(50, GamificationService.POINTS_CREATE_EVENT)
        assertEquals(5, GamificationService.POINTS_VOTE)
        assertEquals(10, GamificationService.POINTS_COMMENT)
        assertEquals(20, GamificationService.POINTS_PARTICIPATE)
        assertEquals(15, GamificationService.POINTS_CREATE_SCENARIO)
        assertEquals(3, GamificationService.POINTS_VOTE_SCENARIO)
    }
}
