{
  "permissions": {
    "allow": [
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git push:*)",
      "Bash(/Users/guy/Developer/dev/wakeve/openspec/proposals/next-priority-specs.md << 'EOF'\n# Priority Implementation Specs\n\n> **Date**: 2026-02-08\n> **Status**: Draft\n> **Based On**: Gap analysis of existing specs vs implementation\n\n---\n\n## Executive Summary\n\nAfter analyzing the existing specifications and current implementation, this document proposes the next priority specs to create.\n\n---\n\n## Priority 1: Security Specification\n\n### Spec: `security-management`\n\n**Rationale**: Recent security patches introduced centralized security components but no specification exists.\n\n**Complexity**: Medium\n\n**Dependencies**: All specs \\(cross-cutting\\)\n\n**Estimated Effort**: 3-5 days\n\n---\n\n## Priority 2: Offline Sync Specification\n\n### Spec: `offline-sync`\n\n**Rationale**: The project claims \"offline-first\" architecture but no comprehensive spec exists.\n\n**Complexity**: High\n\n**Dependencies**: All data-intensive specs\n\n**Estimated Effort**: 5-7 days\n\n---\n\n## Priority 3: Meeting Service Completion\n\n### Spec Update: `meeting-service`\n\n**Rationale**: Current implementation is mock-only. Real implementation requires production API integration.\n\n**Complexity**: Medium\n\n**Dependencies**: workflow-coordination, calendar-management\n\n**Estimated Effort**: 3-4 days\n\n---\n\n## Priority 4: OAuth Provider Completion\n\n### Spec Update: `user-auth`\n\n**Rationale**: Email OTP is implemented, but OAuth \\(Google/Apple\\) is incomplete.\n\n**Complexity**: Medium\n\n**Dependencies**: None \\(foundational\\)\n\n**Estimated Effort**: 2-3 days\n\n---\n\n## Priority 5: Suggestion Engine Specification\n\n### Spec: `suggestion-engine`\n\n**Rationale**: Current spec references AI/ML but lacks concrete algorithms.\n\n**Complexity**: High\n\n**Dependencies**: destination-planning, transport-optimization\n\n**Estimated Effort**: 5-7 days\n\n---\n\n## Implementation Roadmap\n\n### Phase 1: Foundation \\(Week 1-2\\)\n- Create `security-management` spec\n- Update all existing specs with security sections\n\n### Phase 2: Infrastructure \\(Week 3-4\\)\n- Create `offline-sync` spec\n\n### Phase 3: Service Completion \\(Week 5-6\\)\n- Update `meeting-service` spec for production\n- Update `user-auth` spec with OAuth details\n\n### Phase 4: Intelligence \\(Week 7-8\\)\n- Create `suggestion-engine` spec\n\nEOF)",
      "Bash(/Users/guy/Developer/dev/wakeve/openspec/specs/offline-sync/spec.md << 'ENDOFFILE'\n# Specification: Offline Sync\n\n> **Capability**: `offline-sync`\n> **Version**: 1.0.0\n> **Status**: Active\n> **Last Updated**: 2026-02-08\n\n## Overview\n\nThis specification defines the offline-first synchronization strategy for Wakeve. The application uses SQLite as the local source of truth, with background synchronization to a remote backend.\n\n**Version**: 1.0.0\n**Status**: Active\n**Created**: 2026-02-08\n**Maintainer**: Backend Team\n\n[Content abbreviated - full spec created]\nENDOFFILE)",
      "Bash(/Users/guy/Developer/dev/wakeve/openspec/specs/offline-sync/spec.md << 'OFFLINESYNCEOF'\n# Specification: Offline Sync\n\n> **Capability**: `offline-sync`\n> **Version**: 1.0.0\n> **Status**: Active\n> **Last Updated**: 2026-02-08\n\n## Overview\n\nThis specification defines the offline-first synchronization strategy for Wakeve. The application uses SQLite as the local source of truth, with background synchronization to a remote backend. All operations work offline, with changes queued for later synchronization.\n\n**Version**: 1.0.0\n**Status**: Active\n**Created**: 2026-02-08\n**Maintainer**: Backend Team\n\n### Core Concepts\n\n**Local Source of Truth**: SQLite database is the primary data store. All reads come from local data.\n\n**Sync Queue**: Pending operations are queued for background synchronization.\n\n**Conflict Resolution**: When multiple clients modify the same data, conflicts are resolved using last-write-wins based on timestamps.\n\n**Optimistic Locking**: Updates proceed without locking, with conflicts detected and resolved during sync.\n\n### Key Features\n\n- **Offline-First**: Full functionality without network connectivity\n- **Background Sync**: Automatic synchronization when network is available\n- **Conflict Resolution**: Last-write-wins with user notification\n- **Retry Logic**: Exponential backoff for failed sync operations\n- **Sync Indicators**: UI shows pending operations and sync status\n\n### Dependencies\n\n| Dependency | Type | Description |\n|------------|------|-------------|\n| All data specs | Spec | All specs with persistent data follow this pattern |\n\n## Purpose\n\nThe Offline Sync capability ensures users can interact with Wakeve without network connectivity. This is critical for events in areas with poor reception.\n\n### Use Cases\n\n- **Offline Event Creation**: User creates an event while on a plane\n- **Offline Voting**: User votes on dates while at a remote cabin\n- **Background Sync**: Changes automatically sync when WiFi becomes available\n- **Conflict Resolution**: Two users edit the same event, system merges changes\n\n## Requirements\n\n### Requirement: Local-First Data Access\n**ID**: `SYNC-001`\n\nThe system SHALL read all data from the local SQLite database.\n\n#### Scenario: Read events while offline\n- **GIVEN** a user is offline\n- **WHEN** they open the events list\n- **THEN** the system SHALL load events from local SQLite and display immediately\n\n### Requirement: Write Operations with Sync Queue\n**ID**: `SYNC-002`\n\nThe system SHALL queue all write operations for background synchronization.\n\n#### Scenario: Create event while offline\n- **GIVEN** a user is offline\n- **WHEN** they create a new event\n- **THEN** the system SHALL insert into local SQLite and queue for sync\n\n### Requirement: Conflict Resolution\n**ID**: `SYNC-003`\n\nThe system SHALL resolve conflicts using last-write-wins based on updatedAt timestamp.\n\n#### Scenario: Server wins conflict\n- **GIVEN** local has older timestamp than server\n- **WHEN** sync occurs\n- **THEN** apply server changes and notify user\n\n### Requirement: Sync Status Indicators\n**ID**: `SYNC-004`\n\nThe system SHALL display sync status to users.\n\n#### Scenario: Offline indicator\n- **GIVEN** a user is offline\n- **WHEN** viewing any screen\n- **THEN** show \"Offline\" indicator\n\n### Requirement: Retry Logic\n**ID**: `SYNC-005`\n\nThe system SHALL retry failed sync operations with exponential backoff \\(30s, 60s, 120s, 240s, max 1h\\).\n\n### Requirement: Background Sync\n**ID**: `SYNC-006`\n\nThe system SHALL perform background synchronization when conditions are met \\(app foreground, network available, periodic 15min\\).\n\n## Data Models\n\n### Sync Operation\n\n```kotlin\n@Serializable\ndata class SyncOperation\\(\n    val id: String,\n    val type: SyncOperationType,\n    val tableName: String,\n    val recordId: String,\n    val data: String,\n    val createdAt: Instant,\n    val retryCount: Int = 0,\n    val nextRetryAt: Instant? = null,\n    val status: SyncStatus\n\\)\n```\n\n### Sync Operation Type\n\n```kotlin\nenum class SyncOperationType { CREATE, UPDATE, DELETE }\n```\n\n### Sync Status\n\n```kotlin\nenum class SyncStatus {\n    PENDING, IN_PROGRESS, FAILED, PERMANENT_FAILURE, SUCCESS\n}\n```\n\n## API / Interface\n\n### POST /api/sync\n\n**Description**: Synchronize local changes with server\n\n**Request Body**:\n```json\n{\n  \"operations\": [...],\n  \"lastSyncAt\": \"2026-02-08T13:00:00Z\"\n}\n```\n\n**Response 200 OK**:\n```json\n{\n  \"syncedAt\": \"2026-02-08T14:05:00Z\",\n  \"operations\": [{\"id\": \"...\", \"status\": \"SUCCESS\"}],\n  \"conflicts\": [...],\n  \"serverChanges\": [...]\n}\n```\n\n## Security\n\n### Authentication Requirements\n\nAll sync operations require valid JWT token. Sync endpoint enforces user ownership of synced records.\n\n## State Machine Integration\n\n### Sync Intents\n\n```kotlin\nsealed interface SyncIntent : Intent {\n    data class StartSync\\(val force: Boolean = false\\) : SyncIntent\n    data class RetryOperation\\(val operationId: String\\) : SyncIntent\n    object SyncAll : SyncIntent\n}\n```\n\n## Database Schema\n\n```sql\nCREATE TABLE sync_operation \\(\n    id TEXT PRIMARY KEY,\n    type TEXT NOT NULL,\n    table_name TEXT NOT NULL,\n    record_id TEXT NOT NULL,\n    data TEXT NOT NULL,\n    created_at INTEGER NOT NULL,\n    retry_count INTEGER DEFAULT 0,\n    next_retry_at INTEGER,\n    status TEXT NOT NULL DEFAULT 'PENDING'\n\\);\n```\n\n## Testing Requirements\n\n**Coverage Target**: 85%\n\n### Unit Tests\n\n- SyncQueueTest: Enqueue, retry logic\n- ConflictResolutionTest: Server wins, local wins, tie\n- OfflineSyncFlowTest: Offline CREATE → Online sync\n\n### Integration Tests\n\n- BackgroundSyncTest: Sync on app foreground, network available\n\n## Platform-Specific Implementation\n\n### Android: WorkManager\n\n```kotlin\nclass SyncWorker\\(context: Context, params: WorkerParameters\\) : CoroutineWorker\\(context, params\\) {\n    override suspend fun doWork\\(\\): Result = syncManager.syncPendingOperations\\(\\)\n}\n```\n\n### iOS: BGTaskScheduler\n\n```swift\nclass SyncTask: BGTask {\n    func schedule\\(\\) {\n        let request = BGProcessingTaskRequest\\(identifier: \"com.wakeve.sync\"\\)\n        try? BGTaskScheduler.shared.submit\\(request\\)\n    }\n}\n```\n\n## Implementation Files\n\n### Core\n- `shared/src/commonMain/kotlin/com/guyghost/wakeve/sync/SyncManager.kt`\n- `shared/src/commonMain/kotlin/com/guyghost/wakeve/sync/SyncQueue.kt`\n- `shared/src/commonMain/kotlin/com/guyghost/wakeve/sync/ConflictResolver.kt`\n\n### Backend\n- `server/src/main/kotlin/com/guyghost/wakeve/routes/SyncRoutes.kt`\n\n### Android\n- `wakeveApp/src/androidMain/kotlin/com/guyghost/wakeve/service/SyncWorker.kt`\n\n### iOS\n- `wakeveApp/wakeveApp/Services/SyncTask.swift`\n\n## Related Specifications\n\nAll data-intensive specs follow this pattern for offline support.\n\n## Internationalization\n\n| Key | English | French |\n|-----|---------|--------|\n| `sync.offline` | You're offline | Vous êtes hors ligne |\n| `sync.pending` | Pending changes | Modifications en attente |\n| `sync.syncing` | Syncing... | Synchronisation... |\n\n## Performance Considerations\n\n- Batch Size: Up to 100 operations per request\n- Compression: Gzip compress sync payload > 10KB\n- Throttling: Don't sync more than once per 30 seconds automatically\n\n## Change History\n\n| Version | Date | Changes |\n|---------|------|---------|\n| 1.0.0 | 2026-02-08 | Initial version |\n\n## Acceptance Criteria\n\n- [x] All reads work offline immediately\n- [x] All writes queue for background sync\n- [x] Conflicts resolve with last-write-wins\n- [x] Sync status is visible in UI\n- [x] Failed operations retry with exponential backoff\n- [x] Background sync runs on all platforms\n\n## Success Metrics\n\n- < 100ms average read time from local database\n- > 95% sync success rate on good network\n- < 5 minute average sync delay\n\n---\n\n**Spec Version**: 1.0.0\n**Last Updated**: 2026-02-08\n**Status**: Active\n**Maintainer**: Backend Team\nOFFLINESYNCEOF)",
      "Bash(git reset:*)"
    ]
  }
}
